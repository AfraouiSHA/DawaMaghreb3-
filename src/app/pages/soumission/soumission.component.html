<!-- src/app/soumission/soumission.component.html -->

<!-- Le fond flou est g√©r√© par CSS, pas besoin d'un div vide sp√©cifique si c'est juste un effet de style -->

<div class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4 font-sans">
  <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-8 space-y-8">

    <div class="flex justify-center mb-6">
      <img src="assets/image-dawamaghreb/dawamaghreb_logo.jpg" alt="Logo Dawamaghreb" class="h-20" />
    </div>

    <h1 class="text-4xl font-extrabold text-center text-indigo-800 mb-8">Soumissionner √† l'appel d'offres</h1>

    <!-- Utilisation de #soumissionForm="ngForm" pour acc√©der √† l'√©tat du formulaire Angular -->
    <!-- (ngSubmit) doit appeler la m√©thode correcte : soumettreFormulaire -->
    <form class="space-y-6" novalidate (ngSubmit)="soumettreFormulaire(soumissionForm)" #soumissionForm="ngForm">

      <!-- Informations appel d'offres -->
      <section class="bg-indigo-50 p-6 rounded-lg shadow-inner" aria-labelledby="infos-ao-title">
        <h2 id="infos-ao-title" class="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
          <span class="mr-2">üìù</span> Informations sur l‚Äôappel d‚Äôoffres
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="field-group">
            <label for="refAO" class="block text-sm font-medium text-gray-700">R√©f√©rence / Num√©ro</label>
            <!-- Liaison de donn√©es avec formData.refAO -->
            <input id="refAO" name="refAO" type="text" placeholder="Ex: AO-2025-001" autocomplete="off"
                   [(ngModel)]="formData.refAO"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
          </div>
          <div class="field-group">
            <label for="dateLimite" class="block text-sm font-medium text-gray-700">Date limite de soumission</label>
            <!-- Liaison de donn√©es avec formData.dateLimite -->
            <input id="dateLimite" name="dateLimite" type="date"
                   [(ngModel)]="formData.dateLimite"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
          </div>
        </div>
        <div class="field-group mt-4">
          <label for="objetAO" class="block text-sm font-medium text-gray-700">Objet</label>
          <!-- Liaison de donn√©es avec formData.objetAO -->
          <textarea id="objetAO" name="objetAO" placeholder="Objet de l‚Äôappel d‚Äôoffres" rows="3"
                    [(ngModel)]="formData.objetAO"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
        </div>
      </section>

      <!-- Informations entreprise -->
      <section class="bg-blue-50 p-6 rounded-lg shadow-inner" aria-labelledby="infos-entreprise-title">
        <h2 id="infos-entreprise-title" class="text-2xl font-bold text-blue-700 mb-4 flex items-center">
          <span class="mr-2">üè¢</span> Informations sur l‚Äôentreprise
        </h2>

        <div class="field-group">
          <label for="nomEntreprise" class="block text-sm font-medium text-gray-700">
            Nom de l'entreprise <span aria-hidden="true">*</span>
          </label>
          <!-- Liaison de donn√©es avec formData.nomEntreprise -->
          <input id="nomEntreprise" name="nomEntreprise" type="text" placeholder="Nom complet de l'entreprise" required
                 [(ngModel)]="formData.nomEntreprise" #nomEntrepriseCtrl="ngModel"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
          <div *ngIf="nomEntrepriseCtrl.invalid && (nomEntrepriseCtrl.dirty || nomEntrepriseCtrl.touched)"
               class="text-red-600 text-sm mt-1">
            Le nom de l'entreprise est requis.
          </div>
        </div>

        <div class="field-group mt-4">
          <label for="adresse" class="block text-sm font-medium text-gray-700">Adresse</label>
          <!-- Liaison de donn√©es avec formData.adresse -->
          <textarea id="adresse" name="adresse" placeholder="Adresse compl√®te" rows="2"
                    [(ngModel)]="formData.adresse"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"></textarea>
        </div>

        <div class="field-group mt-4">
          <label for="telephone" class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
          <!-- Liaison de donn√©es avec formData.telephone -->
          <input id="telephone" name="telephone" type="tel" placeholder="+212 6 XX XX XX XX"
                 pattern="^\+?\d{1,4}[\d\s\-]{3,}$" autocomplete="tel"
                 [(ngModel)]="formData.telephone"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
          <div *ngIf="soumissionForm.controls['telephone']?.invalid && (soumissionForm.controls['telephone']?.dirty || soumissionForm.controls['telephone']?.touched)"
               class="text-red-600 text-sm mt-1">
            Veuillez entrer un num√©ro de t√©l√©phone valide.
          </div>
        </div>

        <div class="field-group mt-4">
          <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
          <!-- Liaison de donn√©es avec formData.email -->
          <input id="email" name="email" type="email" placeholder="contact@entreprise.ma" autocomplete="email" required
                 [(ngModel)]="formData.email" #emailCtrl="ngModel"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
          <div *ngIf="emailCtrl.invalid && (emailCtrl.dirty || emailCtrl.touched)"
               class="text-red-600 text-sm mt-1">
            Veuillez entrer une adresse email valide.
          </div>
        </div>

        <div class="field-group mt-4">
          <label for="compteBancaire" class="block text-sm font-medium text-gray-700">Compte bancaire</label>
          <!-- Liaison de donn√©es avec formData.compteBancaire -->
          <input id="compteBancaire" name="compteBancaire" type="text" placeholder="Num√©ro de compte"
                 [(ngModel)]="formData.compteBancaire"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="field-group">
            <label for="taxePro" class="block text-sm font-medium text-gray-700">N¬∞ inscription taxe professionnelle</label>
            <!-- Liaison de donn√©es avec formData.taxePro -->
            <input id="taxePro" name="taxePro" type="text"
                   [(ngModel)]="formData.taxePro"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
          </div>
          <div class="field-group">
            <label for="ice" class="block text-sm font-medium text-gray-700">N¬∞ ICE</label>
            <!-- Liaison de donn√©es avec formData.ice -->
            <input id="ice" name="ice" type="text"
                   [(ngModel)]="formData.ice"
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
          </div>
        </div>

        <div class="field-group mt-4">
          <label for="cnss" class="block text-sm font-medium text-gray-700">N¬∞ affiliation CNSS</label>
          <!-- Liaison de donn√©es avec formData.cnss -->
          <input id="cnss" name="cnss" type="text"
                 [(ngModel)]="formData.cnss"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
        </div>
      </section>

      <!-- Devis -->
      <section class="bg-green-50 p-6 rounded-lg shadow-inner" aria-labelledby="devis-title">
        <h2 id="devis-title" class="text-2xl font-bold text-green-700 mb-4 flex items-center">
          <span class="mr-2">üìÑ</span> Devis
        </h2>

        <div class="flex flex-wrap gap-4 mb-4">
          <!-- Le bouton "Remplir le devis" appelle loadExcelData() -->
          <button type="button" (click)="loadExcelData()"
                  class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out">
            Remplir le devis
          </button>
          <button type="button" (click)="telechargerDevis()"
                  class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300 ease-in-out">
            T√©l√©charger le devis (Excel)
          </button>
        </div>

        <!-- Messages de chargement/erreur pour le tableau de devis -->
        <div *ngIf="loading" class="text-indigo-600 text-lg mb-4 text-center">Chargement du devis...</div>
        <div *ngIf="errorMessage" class="text-red-600 text-lg mb-4 text-center">{{ errorMessage }}</div>

        <!-- AG-Grid tableau √©ditable -->
        <!-- Le tableau s'affiche si rowData a des √©l√©ments (charg√© de l'Excel) -->
        <div *ngIf="rowData && rowData.length > 0"
             class="ag-theme-alpine w-full h-96 mt-4 rounded-lg overflow-hidden shadow-lg"
             role="region" aria-label="Tableau de devis √©ditable">
          <ag-grid-angular
            [rowData]="rowData"
            [columnDefs]="columnDefs"
            [defaultColDef]="defaultColDef"
            [animateRows]="true"
            [rowSelection]="'multiple'"
            (cellValueChanged)="onCellValueChanged($event)"
            class="w-full h-full"
          ></ag-grid-angular>
          <button type="button" (click)="saveEditedData()"
                  class="mt-4 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out">
            Enregistrer les modifications du tableau
          </button>
        </div>
        <div *ngIf="!loading && !errorMessage && (!rowData || rowData.length === 0)" class="text-gray-600 mt-4 text-center">
            Cliquez sur "Remplir le devis" pour importer le devis Excel.
        </div>


        <label class="flex items-center mt-4 text-gray-700" for="saveDraft">
          <!-- Liaison de donn√©es avec formData.saveDraft -->
          <input type="checkbox" id="saveDraft" name="saveDraft"
                 [(ngModel)]="formData.saveDraft" (change)="onSaveDraftToggle($event)"
                 class="form-checkbox h-5 w-5 text-indigo-600 rounded-md">
          <span class="ml-2">Enregistrer comme brouillon</span>
        </label>
      </section>

      <!-- Documents √† joindre -->
      <section class="bg-purple-50 p-6 rounded-lg shadow-inner" aria-labelledby="documents-title">
        <h2 id="documents-title" class="text-2xl font-bold text-purple-700 mb-4 flex items-center">
          <span class="mr-2">üìÅ</span> Documents √† joindre
        </h2>

        <h3 class="text-xl font-semibold text-gray-800 mb-3">Offre technique</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="field-group">
            <label for="refProjets" class="block text-sm font-medium text-gray-700">R√©f√©rences projets similaires</label>
            <!-- (change) avec onFileSelect -->
            <input id="refProjets" name="refProjets" type="file" accept=".pdf,.doc,.docx" multiple
                   (change)="onFileSelect($event, 'refProjets')"
                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
          </div>

          <div class="field-group">
            <label for="descriptifsTech" class="block text-sm font-medium text-gray-700">Descriptifs techniques</label>
            <!-- (change) avec onFileSelect -->
            <input id="descriptifsTech" name="descriptifsTech" type="file" accept=".pdf,.doc,.docx" multiple
                   (change)="onFileSelect($event, 'descriptifsTech')"
                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
          </div>

          <div class="field-group">
            <label for="plans" class="block text-sm font-medium text-gray-700">Plans d'implantation / sch√©mas</label>
            <!-- (change) avec onFileSelect -->
            <input id="plans" name="plans" type="file" accept=".pdf,.jpg,.png" multiple
                   (change)="onFileSelect($event, 'plans')"
                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
          </div>

          <div class="field-group">
            <label for="cvTech" class="block text-sm font-medium text-gray-700">CV techniciens & ing√©nieurs</label>
            <!-- (change) avec onFileSelect -->
            <input id="cvTech" name="cvTech" type="file" accept=".pdf,.doc,.docx" multiple
                   (change)="onFileSelect($event, 'cvTech')"
                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
          </div>
        </div>

        <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Documents administratifs</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="field-group">
            <label for="registreCommerce" class="block text-sm font-medium text-gray-700">Registre de Commerce (RC)</label>
            <!-- (change) avec onFileSelect -->
            <input id="registreCommerce" name="registreCommerce" type="file" accept=".pdf,.jpg,.png"
                   (change)="onFileSelect($event, 'registreCommerce')" required
                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
          </div>

          <div class="field-group">
            <label for="attestationCNSS" class="block text-sm font-medium text-gray-700">Attestation CNSS</label>
            <!-- (change) avec onFileSelect -->
            <input id="attestationCNSS" name="attestationCNSS" type="file" accept=".pdf,.jpg,.png"
                   (change)="onFileSelect($event, 'attestationCNSS')" required
                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
          </div>
        </div>
      </section>

      <!-- D√©lais et engagements -->
      <section class="bg-yellow-50 p-6 rounded-lg shadow-inner" aria-labelledby="delais-title">
        <h2 id="delais-title" class="text-2xl font-bold text-yellow-700 mb-4 flex items-center">
          <span class="mr-2">‚è≥</span> D√©lais et engagements
        </h2>

        <div class="field-group mb-4">
          <label for="delaiExecution" class="block text-sm font-medium text-gray-700">D√©lai d'ex√©cution propos√©</label>
          <!-- Liaison de donn√©es avec formData.delaiExecution -->
          <input id="delaiExecution" name="delaiExecution" type="text" placeholder="Ex: 3 mois"
                 [(ngModel)]="formData.delaiExecution"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 p-2">
        </div>

        <label class="flex items-center text-gray-700" for="acceptConditions">
          <!-- Liaison de donn√©es avec formData.acceptConditions -->
          <input type="checkbox" id="acceptConditions" name="acceptConditions" required
                 [(ngModel)]="formData.acceptConditions" #acceptConditionsCtrl="ngModel"
                 class="form-checkbox h-5 w-5 text-yellow-600 rounded-md">
          <span class="ml-2">J'accepte les conditions g√©n√©rales d'appel d'offres</span>
        </label>
        <div *ngIf="acceptConditionsCtrl.invalid && (acceptConditionsCtrl.dirty || acceptConditionsCtrl.touched)"
             class="text-red-600 text-sm mt-1">
          Vous devez accepter les conditions pour soumettre.
        </div>
      </section>

      <!-- Actions du formulaire -->
      <section class="flex flex-wrap justify-center gap-4 mt-8">
        <button type="submit"
                [disabled]="soumissionForm.invalid"
                class="px-8 py-3 bg-orange-600 text-white font-bold rounded-lg shadow-lg hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition duration-300 ease-in-out">
          Soumettre l'offre
        </button>
        <!-- Bouton "R√©initialiser" -->
        <button type="button" (click)="reinitialiserFormulaire(soumissionForm)"
                class="px-8 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300 ease-in-out">
          R√©initialiser le formulaire
        </button>
        <!-- Bouton "Annuler / Retour" -->
        <button type="button" (click)="goBack()"
                class="px-8 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-300 ease-in-out">
          Annuler / Retour
        </button>
      </section>
    </form>
  </div>
</div>

<!-- Modal pour les messages (remplace alert()) -->
<div *ngIf="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl p-6 w-96">
    <h3 class="text-xl font-bold mb-4" [ngClass]="{'text-green-600': modalType === 'success', 'text-red-600': modalType === 'error', 'text-yellow-600': modalType === 'warning', 'text-blue-600': modalType === 'info'}">
      {{ modalTitle }}
    </h3>
    <p class="text-gray-700 mb-6">{{ modalMessage }}</p>
    <div class="flex justify-end">
      <button (click)="closeModal()"
              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        OK
      </button>
    </div>
  </div>
</div>
















































