// Définir le plugin vmenuModule avant son utilisation 
(function ($) {
    $.fn.vmenuModule = function (options) {
        var settings = $.extend({ Speed: 220, autostart: true, autohide: 1 }, options);
        var $menu = $(this);
        var $links = $menu.find("ul").parent("li").children("a");

        $links.attr("data-option", "off");

        $links.off("click").on("click", function () {
            var $this = $(this);

            if (settings.autohide) {
                $this.parent().parent().find("a[data-option='on']").parent("li").children("ul").slideUp(settings.Speed / 1.2, function () {
                    $(this).parent("li").children("a").attr("data-option", "off");
                    $(this).parent("li").removeClass("show");
                });
            }

            if ($this.attr("data-option") === "off") {
                $this.parent("li").children("ul").slideDown(settings.Speed, function () {
                    $this.attr("data-option", "on");
                    $this.parent("li").addClass("show");
                });
            } else {
                $this.attr("data-option", "off");
                $this.parent("li").children("ul").slideUp(settings.Speed);
                $this.parent("li").removeClass("show");
            }
        });

        if (settings.autostart) {
            $menu.find("a").each(function () {
                $(this).parent("li").parent("ul").slideDown(settings.Speed, function () {
                    $(this).parent("li").children("a").attr("data-option", "on");
                });
            });
        } else {
            $menu.find("a.active").each(function () {
                $(this).parent("li").parent("ul").slideDown(settings.Speed, function () {
                    $(this).parent("li").children("a").attr("data-option", "on");
                    $(this).parent("li").addClass("show");
                });
            });
        }
    };
})(window.jQuery || window.Zepto);

// Puis le reste du code dans $(document).ready()
jQuery(document).ready(function ($) {
    "use strict";

    // Initialisation des datepickers sans chargement dynamique
    function initDatepickers() {
        if (typeof $.fn.datepicker !== 'function') {
            console.warn("jQuery UI Datepicker non disponible, vérifie l'inclusion de jQuery UI dans index.html");
            return; // arrêt si datepicker non présent
        }

        $(".date-picker").datepicker({
            dateFormat: "dd MM yy",
            prevText: '<',
            nextText: '>',
            monthNames: ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'],
            monthNamesShort: ['Janv','Fév','Mar','Avr','Mai','Juin','Juil','Août','Sept','Oct','Nov','Déc'],
            dayNamesMin: ['Di','Lu','Ma','Me','Je','Ve','Sa']
        });

        $(".datetimepicker").datepicker({
            dateFormat: "dd MM yy"
        });

        $(".month-picker").datepicker({
            dateFormat: "MM yy"
        });
    }

    // Fonction CopyToClipboard inchangée
    function CopyToClipboard(t, e, o) {
        if ("" != t) {
            var a = $("<input>");
            $("body").append(a);
            a.val(t).select();
            document.execCommand("copy");
            a.remove();
        }
        void 0 === e && (e = !0);
        void 0 === o && (o = "Copied to clipboard");
        var n = $("div.copy-notification");
        if (e && 0 == n.length) {
            n = $("<div/>", { class: "copy-notification", text: o });
            $("body").append(n);
            n.fadeIn("slow", function () {
                setTimeout(function () {
                    n.fadeOut("slow", function () {
                        n.remove();
                    });
                }, 1e3);
            });
        }
    }

    // Initialisation des composants avec vérification des dépendances
    function initComponents() {
        if (typeof $.fn.wysihtml5 === 'function') {
            $(".textarea_editor").wysihtml5({ html: true });
        }

        if (typeof $.fn.mCustomScrollbar === 'function') {
            $(".customscroll").mCustomScrollbar({
                theme: "dark-2",
                scrollInertia: 300,
                autoExpandScrollbar: true,
                advanced: { autoExpandHorizontalScroll: true }
            });
        }

        if (typeof $.fn.select2 === 'function') {
            $(".custom-select2").select2();
        }

        if (typeof $.fn.tooltip === 'function') {
            $('[data-toggle="tooltip"]').tooltip();
        }

        if (typeof $.fn.popover === 'function') {
            $('[data-toggle="popover"]').popover();
        }
    }

    // Autres fonctions
    $(".bg_img").each(function () {
        var $img = $(this);
        $img.hide();
        $img.parent().css({
            background: "url(" + $img.attr("src") + ") no-repeat center center"
        });
    });

    $("img.svg").each(function () {
        var $img = $(this);
        var imgID = $img.attr("id");
        var imgClass = $img.attr("class");
        var imgURL = $img.attr("src");

        $.get(imgURL, function (data) {
            var $svg = $(data).find("svg");
            if (typeof imgID !== "undefined") $svg.attr("id", imgID);
            if (typeof imgClass !== "undefined") $svg.attr("class", imgClass + " replaced-svg");
            $svg.removeAttr("xmlns:a");
            if (!$svg.attr("viewBox") && $svg.attr("height") && $svg.attr("width")) {
                $svg.attr("viewBox", "0 0 " + $svg.attr("height") + " " + $svg.attr("width"));
            }
            $img.replaceWith($svg);
        }, "xml");
    });

    // Initialisation des composants et datepickers
    initDatepickers();
    initComponents();

    // Filtrage liste
    $("#filter_input").on("keyup", function () {
        var value = $(this).val().toLowerCase();
        $("#filter_list .fa-hover").filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
    });

    $(".form-control").on("focus", function () {
        $(this).parent().addClass("focus");
    }).on("focusout", function () {
        $(this).parent().removeClass("focus");
    });

    $('.menu-icon, [data-toggle="left-sidebar-close"]').on("click", function () {
        $("body").toggleClass("sidebar-shrink");
        $(".left-side-bar").toggleClass("open");
        $(".mobile-menu-overlay").toggleClass("show");
    });

    $('[data-toggle="header_search"]').on("click", function () {
        $(".header-search").slideToggle();
    });

    $("[data-color]").each(function () {
        $(this).css("color", $(this).attr("data-color"));
    });
    $("[data-bgcolor]").each(function () {
        $(this).css("background-color", $(this).attr("data-bgcolor"));
    });
    $("[data-border]").each(function () {
        $(this).css("border", $(this).attr("data-border"));
    });

    $("#accordion-menu").vmenuModule({
        Speed: 400,
        autostart: false,
        autohide: true
    });

    // Détection d'Internet Explorer
    (function () {
        var ua = window.navigator.userAgent;
        if (ua.indexOf("MSIE ") > 0 || ua.indexOf("Trident/") > 0) {
            document.querySelector("body").className += " IE";
        }
    })();

    $(".fa-hover").click(function (e) {
        e.preventDefault();
        CopyToClipboard($(this).find(".icon-copy").first().prop("outerHTML"), true, "Copied");
    });

    if (typeof ClipboardJS !== 'undefined') {
        new ClipboardJS(".code-copy").on("success", function (e) {
            CopyToClipboard("", true, "Copied");
            e.clearSelection();
        });
    }
});
